
	  
	  <% if flash[:success].present? %>
          <div data-alert class="flash success">
            <%= flash[:success] %>
          </div>
      <% end %>

      <% if flash[:error].present? %>
          <div data-alert class="flash">
            <%= flash[:error] %>
          </div>
      <% end %>
      
      <% if flash[:message].present? %>
          <div data-alert class="flash">

		      <li><%= flash[:message].first %></li>

          </div>
      <% end %>

	<%= render partial: 'layouts/watchlistHeader' %>
	  
	  <header>
		<div class="nav">
			<div id="searchContainer">
				 <div class="form-wrapper cf">
		  <%= render "form" %>
				 	<div class="instruction-info">
						<a href="#" id="view-instructions" class="instruction-link">What do I need to do?</a>
					</div>
				 </div>
	    	</div>
		</div>
	</header>
	
	<div id="instructions" class="instructions">
		<div class="wrapper">
			<h2 class="instruction-header">To monitor prices, simply head to <a href="http://www.thomson.co.uk" target="_blank" title="Thomon.co.uk (new window)">Thomson.co.uk</a> or <a href="http://www.firstchoice.co.uk" target="_blank" title="Firstchoice.co.uk (new window)">First Choice.co.uk</a></h2>
		
				
		<p class="instruction-step step1"><span class="step-no">Step 1</span>Search for your ideal holiday</p>
		
		
		<p class="instruction-step step2"><span class="step-no">Step 2</span><span class="indent">Select "more details" on<br>the holiday you want to monitor</span></p>	
		
		
		<p class="instruction-step step3"><span class="step-no">Step 3</span>Copy the web address in it's entirety and<br>paste into the box above</p>
		
		
		
		</div>
	</div>



<div class="wrapper group">

	<div class="dashboard-heading group">
		<h1 class="dashboard">You are watching <%= pluralize @holidays.size, "holiday" %></h1>
		<p class="remove-all"><a href="">Remove all holidays</a></p>
	</div>



    <% @holidays.each do |holiday| %>


		<div class="holiday group">
		
			<% if holiday.company == "thomson" %>
					<div class="thomson-company">
			<% else %>
					<div class="firstchoice-company">
			<% end %>
				<%= link_to "Close", holiday_path(holiday), method: :delete, confirm: "Are you sure you want to remove this holiday from your watchlist?", class: "close-btn-20" %>
			</div>
		
				<div class="contents">	
					<div class="hotel-name"><%= holiday.hotel_name %></div>
					<p class="tagline"><%= holiday.location %></p>
					
					<!-- NEEDS TO CHANGE TO ACTUAL IMAGE -->
					<img src="/assets/img.png" class="main">
					
					
					<p class="tagline margin-bottom">Departing:</p>
					<p class="specifics"><%= holiday.dept_date %> <span class="tagline">from</span> <%= holiday.flights %> </p>
					
					<p class="tagline margin-bottom margin-top">Duration:</p>
					<p class="specifics"><%= holiday.duration %> (<%=holiday.party_size %>)</p>
								
					
						<div class="prices group">
							<div class="original-price">
								<p class="price"><%= number_to_currency(holiday.initial_price, :unit => "£", :precision => 0) %></p>
								<p class="tagline margin-top">Price when added<br><%= time_ago_in_words holiday.created_at %> ago</p>
							</div>
							
							<div class="now-price">
							
							<% @history_prices = History.where(:holiday_id => holiday.id).limit(30) %>  
			                <% @today = @history_prices.map {|i| i.price }.last.to_i %>
				                
				                  
				                  <% if @today  == 0 %>
					                  	<p class="price"><i>Unavailable</i></p>
									  	<p class="tagline margin-top">This may have sold out</p>
				                  	
				                  <% else %>
				                  	<p class="price"><%= number_to_currency(@today, :unit => "£", :precision => 0) %> 
				                  	
				                  		<% if @today > holiday.initial_price %>
				                  			<span class="up">(&#8593; £<%=@today - holiday.initial_price %>)</span></p>
				                  			<p class="tagline margin-top">Price today</p>
				                  		<% end %>
				                  	
								  		<% if @today < holiday.initial_price %>
				                  			<span class="down">(&#8595; £<%= holiday.initial_price - @today %>)</span></p>
				                  			<p class="tagline margin-top">Price today</p>
				                  		<% end %>
				                  		
				                  		<% if @today == holiday.initial_price %>
				                  			<p class="tagline margin-top">Price today</p>
				                  			
				                  		<% end %>
				                  	
				                  	
				                  <% end %>
				              </div>  
							
						
						</div>
					
					<div class="centre"><a href="<%= holiday.url %>" target="_blank" class="button">View on <%= holiday.company %></a></div>
					
					<% unless @history_prices.map {|i| i.price }.uniq.length == 1 %>
					
						<div class="chart group">
								<p class="tagline">Price movement in the last <%= pluralize @history_prices.size, "day" %></p>
						
				
									<canvas id="canvas<%= holiday.id %>" height="200" width="280"></canvas>
								
						
							<script>
						
								var lineChartData = {
									labels : [
									<% @history_prices.each do |x| %>
										"",
									<% end %>
									],
									datasets : [
										{
											<% if @today > holiday.initial_price %>
				                  				fillColor : "rgba(209,0,15,0.5)",
					                  		<% end %>
					                  	
									  		<% if @today < holiday.initial_price %>
					                  			fillColor : "rgba(39,174,96,0.5)",
					                  		<% end %>
					                  		
					                  		<% if @today == holiday.initial_price %>
					                  			fillColor : "rgba(220,220,220,0.5)",
					                  		<% end %>
											
											strokeColor : "rgba(220,220,220,1)",
											pointColor : "rgba(220,220,220,1)",
											pointStrokeColor : "#fff",
											data : [
											
											<% @history_prices.each do |x| %>
												<%=x.price%>,
											<% end %>
											]
										}
									]
									
								}
						
							var myLine = new Chart(document.getElementById("canvas<%= holiday.id %>").getContext("2d")).Line(lineChartData);
							
							</script>
							</div>
						<% end %>	
					</div>
					
			</div>
	<%end%>
	</div>

	  <%= render partial: 'layouts/footer' %>

	     <script>
		   $(document).ready(function(){
					  
				  $("#instructions").hide();
				  $("#view-instructions").click(function(){
					  $("#instructions").slideToggle();
				});
			});
				
			</script>
			<script>
			//Equal line heights
			equalheight = function(container){

				var currentTallest = 0,
				     currentRowStart = 0,
				     rowDivs = new Array(),
				     $el,
				     topPosition = 0;
				 $(container).each(function() {
				
				   $el = $(this);
				   $($el).height('auto')
				   topPostion = $el.position().top;
				
				   if (currentRowStart != topPostion) {
				     for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
				       rowDivs[currentDiv].height(currentTallest);
				     }
				     rowDivs.length = 0; // empty the array
				     currentRowStart = topPostion;
				     currentTallest = $el.height();
				     rowDivs.push($el);
				   } else {
				     rowDivs.push($el);
				     currentTallest = (currentTallest < $el.height()) ? ($el.height()) : (currentTallest);
				  }
				   for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
				     rowDivs[currentDiv].height(currentTallest);
				   }
				 });
				}
				
				$(window).load(function() {
				  equalheight('.holiday');
				});
				
				
				$(window).resize(function(){
				  equalheight('.holiday');
				});</script>
